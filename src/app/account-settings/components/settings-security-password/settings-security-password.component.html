<app-settings-panels-data *ngIf="form" [formGroup]="form">
  <p i18n="@@account.changeOrUpdateAccountPassword" class="mb-4">
    Change or update your account password.
  </p>

  <div class="row mb-6 flex flex-wrap">
    <label
      class="row mat-caption"
      [ngClass]="{
        error:
          form.controls.oldPassword?.invalid &&
          form.controls.oldPassword?.touched
      }"
    >
      <strong i18n="@@account.oldPassword">Old password</strong>
    </label>
    <mat-form-field
      appearance="outline"
      class="mat-form-field-min no-hint w-full"
    >
      <input matInput formControlName="oldPassword" type="password" />
    </mat-form-field>
    <mat-error
      class="w-full orc-font-small-print mt-2"
      *ngIf="
        form.hasError('required', 'oldPassword') &&
        form.controls.oldPassword.touched
      "
      i18n="@@account.passwordCannotBeEmpty"
    >
      Password cannot be empty
    </mat-error>
    <mat-error
      class="w-full orc-font-small-print mt-2"
      *ngFor="
        let backendError of form.get('oldPassword').errors
          ? form.get('oldPassword').errors['backendErrors']
          : []
      "
      >{{ backendError }}
    </mat-error>
  </div>

  <div class="input-container">
    <label
      class="row mat-caption"
      [ngClass]="{
        error:
          form.controls.password?.invalid && form.controls.password?.touched
      }"
    >
      <strong i18n="@@account.newPassword">New password</strong>
    </label>
    <div class="mb-6">
      <mat-form-field
        appearance="outline"
        class="mat-form-field-min input-container no-hint"
      >
        <input
          formControlName="password"
          type="password"
          matInput
          autocomplete="new-password"
          id="cy-password-input"
        />
      </mat-form-field>
      <mat-error
        class="w-full orc-font-small-print mt-2"
        *ngIf="
          form.hasError('required', 'password') &&
          form.controls.password.touched
        "
        i18n="@@shared.passwordCantBeEmpty"
      >
        Password cannot be empty
      </mat-error>
      <mat-error
        class="w-full orc-font-small-print mt-2"
        *ngIf="
          !form.hasError('required', 'password') &&
          (form.hasError('minlength', 'password') ||
            form.hasError('pattern', 'password')) &&
          form.controls.password.touched
        "
        i18n="@@register.wrongPasswordPatternV2"
      >
        Password must meet all requirements
      </mat-error>
      <mat-error
        class="w-full orc-font-small-print mt-2"
        *ngIf="form.hasError('maxlength', 'password')"
        i18n="@@register.passwordIsToLongV2"
      >
        Password must be between 8 and 256 characters
      </mat-error>
      <mat-error
        class="w-full orc-font-small-print mt-2"
        *ngIf="this.form.hasError('backendError', 'password')"
      >
        <div
          *ngFor="let error of this.form.getError('backendError', 'password')"
        >
          {{ error }}
        </div>
      </mat-error>
    </div>
    <div class="mb-6">
      <mat-form-field
        appearance="outline"
        class="mat-form-field-min input-container no-hint"
      >
        <input
          formControlName="retypedPassword"
          type="password"
          matInput
          autocomplete="new-password"
          id="cy-password-confirm-input"
        />
      </mat-form-field>
      <mat-error
        class="w-full orc-font-small-print mt-2"
        *ngIf="
          form.hasError('required', 'retypedPassword') &&
          form.controls.retypedPassword.touched
        "
        i18n="@@register.passwordConfirmationRequired"
      >
        Retype your password
      </mat-error>

      <mat-error
        class="w-full orc-font-small-print mt-2"
        *ngIf="
          form.hasError('mismatch', 'retypedPassword') &&
          form.controls.retypedPassword.touched
        "
        i18n="@@register.passwordConfirmationMatchV2"
      >
        Passwords do not match
      </mat-error>
    </div>
  </div>

  <p i18n="@@register.yourPasswordHas">Your password has:</p>
  <ol class="grid gap-4">
    <li>
      <ng-container
        [ngTemplateOutlet]="validate8orMoreCharacters ? invalid : valid"
      ></ng-container>
      <div i18n="@@register.passwordLength">8 or more characters</div>
    </li>
    <li>
      <ng-container
        [ngTemplateOutlet]="validateAtLeastALetterOrSymbol ? invalid : valid"
      ></ng-container>
      <div i18n="@@register.atLeastALetterOrSymbol">
        At least 1 letter or symbol
      </div>
    </li>
    <li>
      <ng-container
        [ngTemplateOutlet]="validateAtLeastANumber ? invalid : valid"
      ></ng-container>
      <div i18n="@@register.atLeastANumber">At least 1 number</div>
    </li>
  </ol>

  @if (twoFactorState) {
  <app-alert-message
    type="warning"
    role="dialog"
    aria-live="polite"
    aria-labelledby="dialogTitle"
    aria-describedby="dialogDescription"
  >
    <div content class="content">
      <div id="dialogDescription">
        As two-factor authentication is currently active on your ORCID account
        you need to enter a 2FA code from your authentication app to continue.
      </div>
    </div>
  </app-alert-message>
  <app-two-factor-input
    codeControlName="twoFactorCode"
    recoveryControlName="twoFactorRecoveryCode"
  >
  </app-two-factor-input>
  }

  <div
    *ngIf="success === true"
    class="error-container"
    i18n="@@account.yourPasswordHasBeenUpdate"
  >
    Your password has been updated
  </div>

  <div class="button-container">
    <button
      (click)="save()"
      [disabled]="!form.valid"
      mat-raised-button
      color="primary"
      i18n="@@shared.saveChanges"
      id="cy-save-password"
    >
      Save changes
    </button>
  </div>

  <ng-template #valid>
    <mat-icon class="checked" class="valid">check_circle</mat-icon>
  </ng-template>

  <ng-template #invalid>
    <mat-icon class="no-checked material-icons-outlined"
      >radio_button_unchecked
    </mat-icon>
  </ng-template>
</app-settings-panels-data>
