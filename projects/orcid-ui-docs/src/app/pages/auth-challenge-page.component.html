<app-documentation-page
  title="Auth Challenge Component"
  description="The &lt;app-auth-challenge&gt; component is a subform that validates user credentials (password) and manages 2FA/recovery code inputs."
>
  <div controls>
    <p>Customize the subform to preview different configurations:</p>

    <div style="display: grid; gap: 16px; margin-bottom: 24px">
      <mat-checkbox [(ngModel)]="showHelpText">
        Display 2FA help text / controls
      </mat-checkbox>

      <mat-checkbox [(ngModel)]="showAlert"> Display alert </mat-checkbox>

      <mat-checkbox [(ngModel)]="showPasswordField">
        Display password field
      </mat-checkbox>

      <mat-checkbox [(ngModel)]="showTwoFactorField">
        Display two-factor field
      </mat-checkbox>

      <button
        style="width: 100px; height: 40px; margin-left: 10px"
        mat-button
        (click)="form.reset()"
      >
        Reset form
      </button>
    </div>
  </div>

  <div examples>
    <form [formGroup]="form" class="w-[537px]">
      <app-auth-challenge
        [showAlert]="showAlert"
        [showHelpText]="showHelpText"
        [showPasswordField]="showPasswordField"
        [showTwoFactorField]="showTwoFactorField"
        codeControlName="twoFactorCode"
        recoveryControlName="twoFactorRecoveryCode"
        passwordControlName="password"
      >
      </app-auth-challenge>
    </form>
  </div>

  <div usage style="font-size: 14px">
    <p>
      This component is a sub-form that must be placed inside a parent
      <code>[formGroup]</code>. It manages the UI switching and validation logic
      between the password field, 2FA code, and recovery code inputs.
    </p>

    <p>To implement this component, use the code highlighted in yellow.</p>

    <h4>1. Template</h4>
    <p>
      Place the component inside your existing form. You can toggle the
      visibility of the password or 2FA fields using the boolean inputs.
    </p>
    <pre><code class="language-html">&lt;form [formGroup]="form" (ngSubmit)="save()"&gt;
  &lt;!-- Other inputs... --&gt;

  <span style="background-color: #fff59d; color: #000;">&lt;app-auth-challenge</span>
    <span style="background-color: #fff59d; color: #000;">[showPasswordField]="true"</span>
    <span style="background-color: #fff59d; color: #000;">[showTwoFactorField]="true"</span>
    <span style="background-color: #fff59d; color: #000;">passwordControlName="password"</span>
    <span style="background-color: #fff59d; color: #000;">codeControlName="twoFactorCode"</span>
    <span style="background-color: #fff59d; color: #000;">recoveryControlName="twoFactorRecoveryCode"</span>
    <span style="background-color: #fff59d; color: #000;">[showAlert]="true"&gt;</span>
  <span style="background-color: #fff59d; color: #000;">&lt;/app-auth-challenge&gt;</span>

&lt;/form&gt;</code></pre>

    <h4>2. Form Configuration</h4>
    <p>
      Initialize the controls in your parent component. Note that
      <code>Validators.required</code> for the 2FA fields is managed
      automatically by the child component.
    </p>
    <pre><code class="language-typescript">this.form = this.fb.group(&#123;
  // ... other controls
  <span style="background-color: #fff59d; color: #000;">password: ['', Validators.required],</span>
  <span style="background-color: #fff59d; color: #000;">twoFactorCode: [null, [Validators.minLength(6), Validators.maxLength(6)]],</span>
  <span style="background-color: #fff59d; color: #000;">twoFactorRecoveryCode: [null, [Validators.minLength(10), Validators.maxLength(10)]],</span>
&#125;);</code></pre>

    <h4>3. Handling Submit & Responses</h4>
    <p>
      Use <code>@ViewChild</code> to access the component. This allows you to
      delegate backend error mapping (invalid password, invalid codes) and focus
      management.
    </p>
    <pre><code class="language-typescript"><span style="background-color: #fff59d; color: #000;">@ViewChild(AuthChallengeComponent) authChallengeComponent: AuthChallengeComponent;</span>

save() &#123;
  if (this.form.valid) &#123;
    this.service.update(this.form.value).subscribe(response => &#123;
      // Pass backend response to child to handle errors (password/2fa) or focus
      <span style="background-color: #fff59d; color: #000;">this.authChallengeComponent?.processBackendResponse(response);</span>
      
      <span style="color: #666">// Used when we don't know if the user</span>
      <span style="color: #666">// has 2fa enabled (e.g. signin)</span>
      <span style="background-color: #fff59d; color: #000;">if (response.twoFactorEnabled && !response.invalidPassword) &#123;</span>
         <span style="background-color: #fff59d; color: #000;">this.twoFactorEnabled = true;</span>
      <span style="background-color: #fff59d; color: #000;">&#125;</span>
    &#125;);
  &#125;
&#125;</code></pre>
    <h4>4. Interface Definition</h4>
    <p>
      The endpoint payload/response object needs to extend the
      <strong><code>AuthChallenge</code></strong> interface/pojo.
    </p>
    <pre><code class="language-typescript">export interface AuthChallenge &#123;
  invalidPassword?: boolean;
  invalidTwoFactorCode?: boolean;
  invalidTwoFactorRecoveryCode?: boolean;
  twoFactorCode?: string;
  twoFactorRecoveryCode?: string;
  twoFactorEnabled?: boolean;
&#125;</code></pre>

    <h4>5. Backend Implementation</h4>
    <p>
      The backend validation consists of two steps: verifying the password and
      validating the 2FA status.
    </p>
    <p>
      <strong>1. Password Check:</strong> First, retrieve the user profile and
      validate the submitted password against the stored encrypted password. If
      it does not match, set the <code>invalidPassword</code> flag and return
      the form.
    </p>
    <p>
      <strong>2. 2FA Check:</strong> If the password is valid, use the
      <code>TwoFactorAuthenticationManager</code>. If no codes are provided, it
      will assume a two-step flow (enabling the <code>twoFactorEnabled</code>
      flag). Otherwise, it validates the provided codes.
    </p>

    <pre><code class="language-java"><span style="background-color: #fff59d; color: #000;">ProfileEntity profile = profileEntityCacheManager.retrieve(getCurrentUserOrcid());</span>

<span style="color: #666">// 1. Validate Password</span>
<span style="background-color: #fff59d; color: #000;">if (form.getPassword() == null || !encryptionManager.hashMatches(form.getPassword(), profile.getEncryptedPassword())) &#123;</span>
    <span style="background-color: #fff59d; color: #000;">form.setInvalidPassword(true);</span>
    <span style="background-color: #fff59d; color: #000;">return form;</span>
<span style="background-color: #fff59d; color: #000;">&#125;</span>

<span style="color: #666">// 2. Validate 2FA</span>
<span style="background-color: #fff59d; color: #000;">if (!twoFactorAuthenticationManager.validateTwoFactorAuthForm(orcid, form)) &#123;</span>
    <span style="background-color: #fff59d; color: #000;">return form;</span>
<span style="background-color: #fff59d; color: #000;">&#125;</span></code></pre>
  </div>

  <div inputs>
    <ul style="font-size: 14px">
      <li>
        <code style="font-weight: bold">passwordControlName</code>:
        <code>string</code>. The name of the form control for the password
        input. (default <code>'passwordControl'</code>)
      </li>
      <li>
        <code style="font-weight: bold">codeControlName</code>:
        <code>string</code>. The name of the form control for the 6-digit
        authentication code. (default <code>'twoFactorCodeControl'</code>)
      </li>
      <li>
        <code style="font-weight: bold">recoveryControlName</code>:
        <code>string</code>. The name of the form control for the 10-character
        recovery code. (default <code>'twoFactorRecoveryCodeControl'</code>)
      </li>
      <li>
        <code style="font-weight: bold">showPasswordField</code>:
        <code>boolean</code>. Whether to display the password input field.
        (default <code>true</code>)
      </li>
      <li>
        <code style="font-weight: bold">showTwoFactorField</code>:
        <code>boolean</code>. Whether to display the 2FA/Recovery input fields.
        (default <code>false</code>)
      </li>
      <li>
        <code style="font-weight: bold">showAlert</code>: <code>boolean</code>.
        Whether to display the notice alert indicating 2FA is active or password
        verification is needed. (default <code>false</code>)
      </li>
      <li>
        <code style="font-weight: bold">showHelpText</code>:
        <code>boolean</code>. Whether to display the helper links (e.g. "Use a
        recovery code instead") below the inputs. (default <code>true</code>)
      </li>
    </ul>
  </div>
</app-documentation-page>
